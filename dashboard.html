<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Artist Dashboard ‚Äî Truly Yours DSP</title>

<!-- ====== BASIC STYLES ====== -->
<style>
    body {
        background: #0d001a;
        color: white;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }
    .navbar {
        background: rgba(255,255,255,0.05);
        padding: 12px;
        display: flex;
        gap: 20px;
        font-size: 18px;
    }
    .navbar a { color: white; text-decoration: none; }
    .container { padding: 30px; }
    li { margin-bottom: 12px; }
    button {
        margin-top: 6px;
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 5px;
        border: none;
        background: #ff2ff5;
        color: black;
    }
</style>

</head>
<body>

<!-- ====== NAV ====== -->
<div class="navbar">
    <a href="index.html">HOME</a>
    <a href="upload.html">UPLOAD MORE</a>
    <a href="#" onclick="logout()">LOG OUT</a>
</div>

<!-- ====== CONTENT ====== -->
<div class="container">
    <h1>Welcome back, <span id="Artist">Artist</span> üåä</h1>
    <p>Your wave is growing ‚Äî keep dropping heat.</p>

    <h2>Your Uploaded Songs üéß</h2>
    <ul id="songList">Loading...</ul>

    <h2>Your YouTube Links üé¨</h2>
    <ul>
        <li><a href="https://youtube.com" target="_blank" style="color:#ff2ff5">Example Link</a></li>
    </ul>
</div>


<!-- üîê AUTH CHECK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9b9me_xmEorNFSMPHsTiDP4u7Pc6jfA",
  authDomain: "truly-yours-dsp-2025.firebaseapp.com",
  projectId: "truly-yours-dsp-2025",
  storageBucket: "truly-yours-dsp-2025.appspot.com",
  messagingSenderId: "369021987682",
  appId: "1:369021987682:web:dbe97e15e0b8fb8bc3bb09"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// üî• THIS IS THE PART THAT STOPS BOUNCING BACK TO LOGIN
onAuthStateChanged(auth, (user) => {
  if (user) {
    document.getElementById("artistname").innerText = user.email.split("@")[0];
  } else {
    location.href = "login.html"; // redirect ONLY if logged out
  }
});

// LOGOUT OPTION
window.logout = async () => {
  await auth.signOut();
  location.href = "login.html";
};
</script>


<!-- ========== LOAD SONGS + STATS ========== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getStorage, ref, listAll, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } 
from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyB9b9me_xmEorNFSMPHsTiDP4u7Pc6jfA",
    authDomain: "truly-yours-dsp-2025.firebaseapp.com",
    projectId: "truly-yours-dsp-2025",
    storageBucket: "truly-yours-dsp-2025.appspot.com",
    messagingSenderId: "369021987682",
    appId: "1:369021987682:web:dbe97e15e0b8fb8bc3bb09"
};

const app = initializeApp(firebaseConfig);
const storage = getStorage(app);
const db = getFirestore(app);

const songList = document.getElementById("songList");

// ==== LOAD SONGS ====
async function loadSongs() {
    songList.innerHTML = "Loading‚Ä¶ üîÑ";

    const folder = ref(storage, "artists_audio/");
    const files = await listAll(folder);

    if (!files.items.length) {
        songList.innerHTML = "<li>No songs yet ‚Äî upload one üî•</li>";
        return;
    }

    songList.innerHTML = "";

    for (const fileRef of files.items) {
        const url = await getDownloadURL(fileRef);
        const fileName = fileRef.name.replace(/^\d+-/, "");

        const statRef = doc(db, "stats", fileRef.name);
        let stats = await getDoc(statRef);

        if (!stats.exists()) {
            await setDoc(statRef, { plays: 0, views: 0 });
            stats = await getDoc(statRef);
        }

        const { plays, views } = stats.data();

        const li = document.createElement("li");
        li.innerHTML = `
            üéµ <strong>${fileName}</strong><br>
            ‚ñ∂Ô∏è Plays: ${plays} &nbsp; üëÅ Views: ${views}<br>
            <button onclick="playSong('${fileRef.name}', '${url}')">PLAY</button>
        `;
        songList.appendChild(li);
    }
}

window.playSong = async (filename, url) => {
    const audio = new Audio(url);
    audio.play();

    const statRef = doc(db, "stats", filename);
    await updateDoc(statRef, {
        plays: increment(1),
        views: increment(1),
    });

    loadSongs();
};

loadSongs();
</script>

</body>
</html>
